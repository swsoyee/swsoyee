---
title: Calculate Estimated R in Japan
author: Su Wei
date: '2021-02-01'
slug: calculate-estimated-r-in-japan
output:
  blogdown::html_page:
    toc: true
categories: [English]
tags: [r,echarts,covid19]
summary: 'In this article, I will show how to plot an interactive effective reproduction number line plot using R and `{echarts4r}`. However, since I do not know any epidemic theory, I will not explain too much about the model. The same code also been used in [COVID-19 BULLETIN BOARD](https://covid-2019.live/en).'
---

In this article, I will show how to plot an interactive effective reproduction number line plot using R and `{echarts4r}`. However, since I do not know any epidemic theory, I will not explain too much about the model.

The same code also been used in [COVID-19 BULLETIN BOARD](https://covid-2019.live/en).


## 1. Install Packages

First, install all the packages we need. Some minor bugs in {echarts4r} has been fixed in development version but has not been release to CRAN, so we need to install the Github version here.

```{r install pacakge, eval=FALSE}
install.packages("incidence")
install.packages("EpiEstim")
install.packages("data.table")
install.packages("remotes")
remotes::install_github("JohnCoene/echarts4r")
```

## 2. Create the Dataset for Plotting

```{r calculate Rt}
# Load packages
library(echarts4r)
library(incidence)
library(EpiEstim)
library(data.table)

# Read the dataset from `2019-ncov-japan`
byDate <-
  fread(
    "https://raw.githubusercontent.com/swsoyee/2019-ncov-japan/master/50_Data/byDate.csv"
  )
byDate[is.na(byDate)] <- 0

# Paramsters refer to https://www.ijidonline.com/article/S1201-9712(20)30119-3/fulltext
mean_si <- 4.6
std_si <- 2.6

# Store all names of prefecture
pref <- colnames(byDate)[2:48]

# For storing all echarts4r object in to one htmlwidgets objects
output_list <- list()


#' Function for generate a dataset contains dates and incidences, and Rt
#'
#' @param dataset dataset from `2019-ncov-japan`.
#' @param pref prefecture name.
#'
#' @return a `data.table` for ploting.
createEstimateFromSource <- function(dataset, pref) {
  incid <-
    as.incidence(
      rowSums(dataset[, pref, with = FALSE]),
      dates = as.Date(as.character(dataset$date), format = "%Y%m%d")
    )

  res <- suppressMessages(suppressWarnings(
    estimate_R(incid,
      method = "parametric_si",
      config = make_config(list(
        mean_si = mean_si,
        std_si = std_si,
        t_end = max(incid$dates)
      ))
    )
  ))
  dt <- as.data.table(res$R)
  cols <- colnames(dt)
  dt[, (cols) := lapply(.SD, function(x) {
    return(round(x, 2))
  }), .SDcols = cols]

  dt$dates <- res$dates[res$R$t_end]
  dt$Incidence <- res$I[res$R$t_end]

  dt
}
# Test
tokyo <- createEstimateFromSource(byDate, "東京")
tokyo
```


## 3. Draw the Curve

Next, create a function that pass the dataset generated by previous step in, and draw it by `{echarts4r}`.

```{r draw the curve}
#' Function for generate a echarts4r object contains a Rt line for one prefecture.
#'
#' @param dataset `data.table` for ploting generated by previous function.
#' @param pref prefecture name.
#' 
#' @return a echarts4r object contains a Rt line for one prefecture.
createRtLineFromEstimate <- function(dataset, pref) {
  dataset %>%
    e_chart(dates, height = "250px") %>%
    e_line(
      serie = `Mean(R)`,
      symbolSize = 0,
      name = "Rt"
    ) %>%
    e_bar(
      serie = Incidence,
      y_index = 1,
      barCategoryGap = "10%",
      name = "Incidence"
    ) %>%
    e_band(
      min = `Quantile.0.05(R)`,
      max = `Quantile.0.95(R)`
    ) %>%
    e_tooltip(trigger = "axis") %>%
    e_datazoom(
      minValueSpan = 28,
      startValue = (max(dataset$dates, na.rm = T) - 90)
    ) %>%
    e_legend(top = "10%") %>%
    e_y_axis(
      name = "Rt",
      nameLocation = "middle",
      splitLine =
        list(lineStyle = list(opacity = 0.4)),
      z = 999,
      axisLabel = list(inside = T),
      axisTick = list(show = F)
    ) %>%
    e_y_axis(
      name = "Incidence",
      nameGap = 10,
      splitLine = list(show = F),
      z = 999,
      index = 1,
      axisTick = list(show = F)
    ) %>%
    e_mark_line(
      data = list(yAxis = 1),
      symbolSize = 0,
      label = list(show = FALSE)
    ) %>%
    e_grid(
      left = "8%",
      right = "15%"
    ) %>%
    e_title(
      text = sprintf(
        "%s - Rt: %s±%s（%s）",
        pref,
        tail(dataset$`Mean(R)`, 1)[[1]],
        tail(dataset$`Std(R)`, 1)[[1]],
        tail(dataset$dates, 1)[[1]]
      ),
      subtext = sprintf(
        "Serial interval: %s±%s",
        mean_si, std_si
      )
    )
}

# Test
createRtLineFromEstimate(tokyo, "東京")

# Generate each prefectures Rt line via loop
for (selectedPref in pref) {
  dataset <- createEstimateFromSource(byDate, selectedPref)

  e <- createRtLineFromEstimate(dataset, selectedPref)

  output_list <- c(output_list, list(e))
}

# Render them all at once!
e_arrange(output_list)
```
